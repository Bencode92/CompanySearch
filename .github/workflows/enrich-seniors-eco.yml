name: Enrich Senior Directors ECO

on:
  workflow_dispatch:
    inputs:
      input_file:
        description: "CSV d'entrée (SIREN par ligne)"
        required: false
        default: "output/sirens_interim_HCR_75_92.csv"
        type: string
      output_file:
        description: "CSV de sortie"
        required: false
        default: "output/dirigeants_eco.csv"
        type: string

jobs:
  enrich-seniors-eco:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies (strict with fallback)
        run: npm ci || npm i --no-audit --no-fund

      - name: Check input CSV exists
        id: check_input
        run: |
          INPUT_FILE="${{ inputs.input_file || 'output/sirens_interim_75_92.csv' }}"
          if [ ! -f "$INPUT_FILE" ]; then
            echo "❌ Fichier introuvable: $INPUT_FILE"
            echo "👉 Lancez d'abord le workflow 'Get SIREN List Paris-92'"
            exit 1
          fi
          COUNT=$(tail -n +2 "$INPUT_FILE" | wc -l)
          echo "✅ Fichier trouvé : $COUNT SIREN à traiter"
          echo "siren_count=$COUNT" >> $GITHUB_OUTPUT

      - name: Enrichissement ÉCONOMIQUE (0,1 crédit/dirigeant)
        env:
          PAPPERS_API_KEY: ${{ secrets.PAPPERS_API_KEY }}
          # Optionnel: pour remplir la colonne Objet_social avec /entreprise (coûts)
          PAPPERS_FETCH_ENTREPRISE: "0"
        run: |
          if [ -z "$PAPPERS_API_KEY" ]; then
            echo "❌ Secret PAPPERS_API_KEY manquant !"
            exit 1
          fi
          node scripts/enrich_seniors_eco.js \
            --in="${{ inputs.input_file || 'output/sirens_interim_75_92.csv' }}" \
            --out="${{ inputs.output_file || 'output/dirigeants_eco.csv' }}"

      - name: Analyze results
        id: analyze
        run: |
          OUT="${{ inputs.output_file || 'output/dirigeants_eco.csv' }}"
          if [ -f "$OUT" ]; then
            LINES=$(tail -n +2 "$OUT" | wc -l)
            echo "dirigeants_count=$LINES" >> $GITHUB_OUTPUT
            CREDITS_USED=$(echo "scale=1; $LINES * 0.1" | bc)
            echo "credits_used=$CREDITS_USED" >> $GITHUB_OUTPUT
            head -n 11 "$OUT" | column -t -s ','
          else
            echo "dirigeants_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Upload results
        if: steps.analyze.outputs.dirigeants_count != '0'
        uses: actions/upload-artifact@v4
        with:
          name: dirigeants-eco-${{ github.run_number }}
          path: ${{ inputs.output_file || 'output/dirigeants_eco.csv' }}
          retention-days: 90

      - name: Commit results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          OUT="${{ inputs.output_file || 'output/dirigeants_eco.csv' }}"
          git add -f "$OUT" 2>/dev/null || true
          COUNT="${{ steps.analyze.outputs.dirigeants_count || '0' }}"
          CREDITS="${{ steps.analyze.outputs.credits_used || '0' }}"
          git commit -m "ECO: $COUNT dirigeants (Président) - ~${CREDITS} crédits" || echo "Pas de changements"
          git push || true

      - name: Summary
        run: |
          echo "# 💰 Enrichissement ÉCO - Dirigeants (sans filtre d'âge)" >> $GITHUB_STEP_SUMMARY
          echo "- Entreprises traitées: ${{ steps.check_input.outputs.siren_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dirigeants trouvés: ${{ steps.analyze.outputs.dirigeants_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- Crédits utilisés (≈): ${{ steps.analyze.outputs.credits_used }}" >> $GITHUB_STEP_SUMMARY
